# RFC 6902: JSON Patch

This guide explains the JSON Patch specification (RFC 6902) and how zen-json-patch implements it.

## Overview

[RFC 6902](https://tools.ietf.org/html/rfc6902) defines a JSON document structure for expressing a sequence of operations to apply to a JSON document. It's designed to minimize network traffic when synchronizing JSON documents.

## Specification

### Document Structure

A JSON Patch document is a JSON array where each element is an operation object:

```json
[
  { "op": "add", "path": "/name", "value": "Alice" },
  { "op": "remove", "path": "/age" },
  { "op": "replace", "path": "/email", "value": "alice@example.com" }
]
```

### Operations

RFC 6902 defines six operation types. zen-json-patch currently generates three:

## Add Operation

Adds a value to an object member or inserts into an array.

### Specification

```typescript
{
  "op": "add",
  "path": "/path/to/property",
  "value": <any JSON value>
}
```

### Object Properties

```typescript
const operations = diff(
  { name: "Alice" },
  { name: "Alice", age: 30 }
);
// [{ op: 'add', path: '/age', value: 30 }]
```

### Array Elements

```typescript
const operations = diff(
  { items: [1, 2, 3] },
  { items: [1, 2, 3, 4] }
);
// [{ op: 'add', path: '/items/3', value: 4 }]
```

### Behavior

- **Objects**: Creates a new member
- **Arrays**: Inserts at the specified index, shifting subsequent elements
- If the path doesn't exist, intermediate objects/arrays are created

## Remove Operation

Removes a value from an object member or array element.

### Specification

```typescript
{
  "op": "remove",
  "path": "/path/to/property"
}
```

### Object Properties

```typescript
const operations = diff(
  { name: "Alice", age: 30 },
  { name: "Alice" }
);
// [{ op: 'remove', path: '/age' }]
```

### Array Elements

```typescript
const operations = diff(
  { items: [1, 2, 3] },
  { items: [1, 3] }
);
// [
//   { op: 'replace', path: '/items/1', value: 3 },
//   { op: 'remove', path: '/items/2' }
// ]
```

### Behavior

- **Objects**: Deletes the member
- **Arrays**: Removes the element and shifts subsequent elements left
- Removing a non-existent path should fail when applying the patch

## Replace Operation

Replaces the value at the target location.

### Specification

```typescript
{
  "op": "replace",
  "path": "/path/to/property",
  "value": <any JSON value>
}
```

### Examples

```typescript
const operations = diff(
  { name: "Alice", age: 30 },
  { name: "Alice", age: 31 }
);
// [{ op: 'replace', path: '/age', value: 31 }]
```

### Behavior

- Functionally equivalent to a `remove` followed by an `add`
- More efficient as a single operation
- Can change the value type

```typescript
diff({ value: 42 }, { value: "string" })
// [{ op: 'replace', path: '/value', value: 'string' }]
```

## Operations Not Yet Generated

zen-json-patch currently focuses on `add`, `remove`, and `replace` operations. These three operations can describe any change between JSON documents. The following operations are defined in RFC 6902 but not yet generated:

### Move Operation

```typescript
{
  "op": "move",
  "from": "/path/to/source",
  "path": "/path/to/destination"
}
```

Moves a value from one location to another. Equivalent to a `remove` from the source followed by an `add` to the destination.

**Potential Use**: Detecting when a property is moved rather than removed and added separately.

### Copy Operation

```typescript
{
  "op": "copy",
  "from": "/path/to/source",
  "path": "/path/to/destination"
}
```

Copies a value from one location to another. The source location remains unchanged.

**Potential Use**: Detecting when the same value appears in multiple locations.

### Test Operation

```typescript
{
  "op": "test",
  "path": "/path/to/property",
  "value": <expected value>
}
```

Tests that a value at the target location is equal to a specified value. Used for conditional patching.

**Use Case**: Not typically generated by diff algorithms, but useful when applying patches to ensure preconditions are met.

::: info Future Plans
`move` and `copy` operations may be added in future versions as optimizations. They would reduce patch size and improve performance for certain use cases.
:::

## JSON Pointer Paths

Paths use JSON Pointer syntax (RFC 6901). See the [RFC 6901 guide](/guide/rfc6901) for details.

```typescript
'/'           // Root
'/a'          // Property 'a'
'/a/b'        // Nested property
'/items/0'    // Array index 0
'/a~0b'       // Property 'a~b' (escaped ~)
'/a~1b'       // Property 'a/b' (escaped /)
```

## Compliance

zen-json-patch generates RFC 6902 compliant JSON Patch documents:

- Operations include required fields (`op`, `path`)
- Paths use valid JSON Pointer syntax (RFC 6901)
- Values are JSON-compatible
- Operation semantics match the specification

### Testing

The library includes comprehensive RFC compliance tests:

```typescript
// From rfc6902.spec.ts
describe('RFC 6902 Compliance', () => {
  it('generates valid add operations', () => {
    const ops = diff({}, { a: 1 });
    expect(ops).toEqual([
      { op: 'add', path: '/a', value: 1 }
    ]);
  });

  it('generates valid remove operations', () => {
    const ops = diff({ a: 1 }, {});
    expect(ops).toEqual([
      { op: 'remove', path: '/a' }
    ]);
  });

  it('generates valid replace operations', () => {
    const ops = diff({ a: 1 }, { a: 2 });
    expect(ops).toEqual([
      { op: 'replace', path: '/a', value: 2 }
    ]);
  });
});
```

## Applying Patches

zen-json-patch generates patches but doesn't apply them. To apply patches, use a library like:

- [fast-json-patch](https://github.com/Starcounter-Jack/JSON-Patch) - Popular, well-tested
- [rfc6902](https://github.com/chbrown/rfc6902) - Strictly RFC compliant
- [json-patch](https://github.com/dharmafly/jsonpatch.js) - Another option

### Example with fast-json-patch

```typescript
import { diff } from 'zen-json-patch';
import { applyPatch } from 'fast-json-patch';

const source = { name: "Alice", age: 30 };
const target = { name: "Alice", age: 31, role: "admin" };

// Generate patch
const operations = diff(source, target);

// Apply patch
const result = applyPatch(source, operations).newDocument;

console.log(result);
// { name: 'Alice', age: 31, role: 'admin' }
```

## Use Cases

### Network Efficiency

Instead of sending entire objects:

```typescript
// Bad: Send full object (large payload)
await api.post('/users/123', fullUserObject);

// Good: Send only changes (small payload)
const patch = diff(oldUser, newUser);
await api.patch('/users/123', patch);
```

### Version Control

Track changes over time:

```typescript
const versions = [v1, v2, v3];
const patches = [];

for (let i = 1; i < versions.length; i++) {
  patches.push(diff(versions[i - 1], versions[i]));
}

// patches now contains the history of changes
```

### Conflict Detection

Detect conflicts in concurrent edits:

```typescript
const base = { name: "Alice", age: 30 };
const userA = { name: "Alice A", age: 30 };
const userB = { name: "Alice B", age: 31 };

const patchA = diff(base, userA);
const patchB = diff(base, userB);

// Check for conflicts
const conflicts = patchA.filter(opA =>
  patchB.some(opB => opB.path === opA.path)
);

if (conflicts.length > 0) {
  console.log('Conflicting changes detected');
}
```

## Resources

- [RFC 6902 Specification](https://tools.ietf.org/html/rfc6902) - Official specification
- [RFC 6901 (JSON Pointer)](/guide/rfc6901) - Path syntax used in operations
- [JSON Patch Test Suite](https://github.com/json-patch/json-patch-tests) - Comprehensive test cases

## Next Steps

- [RFC 6901 Guide](/guide/rfc6901) - JSON Pointer path syntax
- [API Reference](/api/) - Complete API documentation
- [Examples](/examples/) - Real-world usage patterns
