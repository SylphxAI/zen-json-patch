# RFC 6901: JSON Pointer

This guide explains JSON Pointer syntax (RFC 6901), which is used for paths in JSON Patch operations.

## Overview

[RFC 6901](https://tools.ietf.org/html/rfc6901) defines a string syntax for identifying a specific value within a JSON document. JSON Patch operations use JSON Pointers to specify which part of the document to modify.

## Syntax

A JSON Pointer is a string of tokens separated by `/` characters. Each token is either:

- A key name (for objects)
- An index (for arrays)
- A special character (`-` for array append)

### Basic Examples

```typescript
// Document
{
  "name": "Alice",
  "age": 30,
  "address": {
    "city": "NYC",
    "zip": "10001"
  },
  "hobbies": ["reading", "coding"]
}

// Pointers
''                  // Root (entire document)
'/name'             // "Alice"
'/age'              // 30
'/address'          // { city: "NYC", zip: "10001" }
'/address/city'     // "NYC"
'/address/zip'      // "10001"
'/hobbies'          // ["reading", "coding"]
'/hobbies/0'        // "reading"
'/hobbies/1'        // "coding"
```

## Path Components

### Root Path

The empty string `''` or `'/'` refers to the entire document:

```typescript
diff({ a: 1 }, { b: 2 })
// When comparing non-objects at root, path is ''
```

### Object Properties

Property names follow a `/`:

```typescript
'/name'             // Top-level property 'name'
'/user/profile'     // Property 'profile' in object 'user'
'/a/b/c'            // Nested three levels deep
```

### Array Indices

Array elements use numeric indices (0-based):

```typescript
'/items/0'          // First element
'/items/1'          // Second element
'/items/10'         // Eleventh element
'/users/2/name'     // Property 'name' of third user
```

### Array Append

The special token `-` refers to the (nonexistent) element after the last array element:

```typescript
// Used when adding to the end of an array
{ op: 'add', path: '/items/-', value: 'new' }
```

::: info
zen-json-patch uses numeric indices rather than `-` when generating patches for array additions.
:::

## Special Characters

Some characters have special meaning and must be escaped.

### Escaping Rules

| Character | Must be escaped as | Reason |
|-----------|-------------------|--------|
| `~` (tilde) | `~0` | Used as escape character |
| `/` (slash) | `~1` | Used as path separator |

### Tilde Escaping

```typescript
// Property name contains ~
const obj = { "a~b": 1 };

// In JSON Pointer
'/a~0b'  // Refers to property "a~b"
```

Example:

```typescript
diff({ "user~name": "Alice" }, { "user~name": "Bob" })
// [{ op: 'replace', path: '/user~0name', value: 'Bob' }]
```

### Slash Escaping

```typescript
// Property name contains /
const obj = { "a/b": 1 };

// In JSON Pointer
'/a~1b'  // Refers to property "a/b"
```

Example:

```typescript
diff({ "http://example": 1 }, { "http://example": 2 })
// [{ op: 'replace', path: '/http:~1~1example', value: 2 }]
```

### Combined Escaping

```typescript
// Property name contains both ~ and /
const obj = { "~1/0~": "value" };

// In JSON Pointer
'/~01~10~0'  // Refers to property "~1/0~"
```

## Evaluation

To evaluate a JSON Pointer:

1. Start with the root document
2. Split the pointer by `/` (after the leading `/`)
3. For each token:
   - Unescape `~1` to `/` and `~0` to `~`
   - If current value is an object, use token as key
   - If current value is an array, parse token as index
4. Return the referenced value

### Example Evaluation

```typescript
// Document
{
  "users": [
    { "name": "Alice", "age": 30 },
    { "name": "Bob", "age": 25 }
  ]
}

// Pointer: '/users/1/name'
// Step 1: Start with document
// Step 2: Split: ['users', '1', 'name']
// Step 3a: document['users'] → array
// Step 3b: array[1] → { name: "Bob", age: 25 }
// Step 3c: object['name'] → "Bob"
// Result: "Bob"
```

## Path Generation

zen-json-patch automatically generates correct JSON Pointer paths:

### Simple Properties

```typescript
diff({ a: 1 }, { a: 2 })
// Path: '/a'
```

### Nested Properties

```typescript
diff(
  { user: { profile: { name: "Alice" } } },
  { user: { profile: { name: "Bob" } } }
)
// Path: '/user/profile/name'
```

### Array Elements

```typescript
diff(
  { items: [1, 2, 3] },
  { items: [1, 5, 3] }
)
// Path: '/items/1'
```

### Special Characters

```typescript
diff(
  { "prop~with~tildes": 1 },
  { "prop~with~tildes": 2 }
)
// Path: '/prop~0with~0tildes'

diff(
  { "prop/with/slashes": 1 },
  { "prop/with/slashes": 2 }
)
// Path: '/prop~1with~1slashes'
```

## Implementation

zen-json-patch includes utilities for working with JSON Pointers:

### Path Building

```typescript
// From path.ts
function appendPath(currentPath: string, key: string): string {
  // Escape special characters
  const escapedKey = key.replace(/~/g, '~0').replace(/\//g, '~1');
  return currentPath + '/' + escapedKey;
}
```

### Usage in diff

```typescript
function compareObjects(obj1, obj2, path, operations) {
  for (const key of Object.keys(obj1)) {
    const currentPath = appendPath(path, key);
    // Use currentPath in operations
  }
}
```

## Edge Cases

### Empty String Property

```typescript
const obj = { "": "empty string key" };

// Pointer
'/'  // Refers to property ""
```

Example:

```typescript
diff({ "": 1 }, { "": 2 })
// [{ op: 'replace', path: '/', value: 2 }]
```

### Numeric String Properties

Object properties that are numeric strings are treated as strings, not indices:

```typescript
const obj = {
  "0": "string key",
  "items": [1, 2, 3]
};

'/0'        // Property "0" of root object
'/items/0'  // First element of array
```

### Unicode

JSON Pointers support Unicode characters:

```typescript
const obj = { "日本語": "Japanese" };

// No escaping needed
'/日本語'  // Refers to property "日本語"
```

## Validation

When working with JSON Pointers, consider:

### Path Existence

A path may not exist:

```typescript
const obj = { a: 1 };

// Path '/b' doesn't exist
// - For diff: generates 'add' operation
// - For patch: may fail or create
```

### Type Mismatches

A path may reference the wrong type:

```typescript
const obj = { value: "string" };

// Path '/value/nested' expects object
// But 'value' is a string
```

### Invalid Indices

Array indices must be valid:

```typescript
const obj = { items: [1, 2, 3] };

// Valid: '/items/0', '/items/1', '/items/2'
// Invalid: '/items/3' (out of bounds)
// Invalid: '/items/abc' (not a number)
```

## Resources

- [RFC 6901 Specification](https://tools.ietf.org/html/rfc6901) - Official specification
- [RFC 6902 (JSON Patch)](/guide/rfc6902) - Uses JSON Pointers for operation paths
- [JSON Pointer Evaluation Tool](https://json-pointer.dev) - Online tool for testing

## Examples in zen-json-patch

### Simple Path

```typescript
diff({ name: "Alice" }, { name: "Bob" })
// [{ op: 'replace', path: '/name', value: 'Bob' }]
```

### Nested Path

```typescript
diff(
  { user: { settings: { theme: "dark" } } },
  { user: { settings: { theme: "light" } } }
)
// [{ op: 'replace', path: '/user/settings/theme', value: 'light' }]
```

### Array Index Path

```typescript
diff(
  { scores: [10, 20, 30] },
  { scores: [10, 25, 30] }
)
// [{ op: 'replace', path: '/scores/1', value: 25 }]
```

### Escaped Path

```typescript
diff(
  { "user/name": "Alice" },
  { "user/name": "Bob" }
)
// [{ op: 'replace', path: '/user~1name', value: 'Bob' }]
```

## Next Steps

- [RFC 6902 Guide](/guide/rfc6902) - JSON Patch specification
- [Usage Guide](/guide/usage) - Core concepts and patterns
- [API Reference](/api/) - Complete API documentation
