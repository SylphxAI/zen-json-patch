# API Reference

Complete API documentation for zen-json-patch.

## diff()

The primary function for generating JSON Patch operations by comparing two objects.

### Signature

```typescript
function diff(obj1: any, obj2: any): Operation[]
```

### Parameters

#### obj1

- **Type**: `any`
- **Description**: The source object (original state)
- **Requirements**: Must be JSON-compatible (serializable with `JSON.stringify`)

#### obj2

- **Type**: `any`
- **Description**: The target object (new state)
- **Requirements**: Must be JSON-compatible (serializable with `JSON.stringify`)

### Returns

- **Type**: `Operation[]`
- **Description**: Array of JSON Patch operations representing the difference between `obj1` and `obj2`
- **Empty Array**: Returns `[]` when objects are identical

### Type Definitions

```typescript
import {
  diff,
  Operation,
  AddOperation,
  RemoveOperation,
  ReplaceOperation
} from 'zen-json-patch';
```

## Types

### Operation

Union type representing all possible operations:

```typescript
type Operation =
  | AddOperation
  | RemoveOperation
  | ReplaceOperation
  | MoveOperation    // Not yet generated
  | CopyOperation    // Not yet generated
  | TestOperation    // Not yet generated
```

### AddOperation

Represents an addition of a property or array element.

```typescript
interface AddOperation {
  op: 'add';
  path: string;  // JSON Pointer path
  value: any;    // Value to add
}
```

**Example:**
```typescript
{ op: 'add', path: '/name', value: 'Alice' }
```

### RemoveOperation

Represents removal of a property or array element.

```typescript
interface RemoveOperation {
  op: 'remove';
  path: string;  // JSON Pointer path
}
```

**Example:**
```typescript
{ op: 'remove', path: '/age' }
```

### ReplaceOperation

Represents replacement of an existing value.

```typescript
interface ReplaceOperation {
  op: 'replace';
  path: string;  // JSON Pointer path
  value: any;    // New value
}
```

**Example:**
```typescript
{ op: 'replace', path: '/age', value: 31 }
```

### MoveOperation

Defined in RFC 6902 but not yet generated by zen-json-patch.

```typescript
interface MoveOperation {
  op: 'move';
  path: string;  // Destination path
  from: string;  // Source path
}
```

### CopyOperation

Defined in RFC 6902 but not yet generated by zen-json-patch.

```typescript
interface CopyOperation {
  op: 'copy';
  path: string;  // Destination path
  from: string;  // Source path
}
```

### TestOperation

Defined in RFC 6902 but not typically generated by diff algorithms.

```typescript
interface TestOperation {
  op: 'test';
  path: string;  // Path to test
  value: any;    // Expected value
}
```

## Usage Examples

### Basic Usage

```typescript
import { diff } from 'zen-json-patch';

const operations = diff(
  { name: "Alice", age: 30 },
  { name: "Alice", age: 31, role: "admin" }
);

console.log(operations);
// [
//   { op: 'replace', path: '/age', value: 31 },
//   { op: 'add', path: '/role', value: 'admin' }
// ]
```

### With Type Safety

```typescript
import { diff, Operation } from 'zen-json-patch';

interface User {
  name: string;
  age: number;
  email?: string;
}

const before: User = { name: "Alice", age: 30 };
const after: User = { name: "Alice", age: 31, email: "alice@example.com" };

const operations: Operation[] = diff(before, after);

// Type-safe operation handling
operations.forEach((op) => {
  if (op.op === 'add' || op.op === 'replace') {
    console.log(`Path: ${op.path}, Value: ${op.value}`);
  } else if (op.op === 'remove') {
    console.log(`Removed: ${op.path}`);
  }
});
```

### Checking for Changes

```typescript
import { diff } from 'zen-json-patch';

const operations = diff(oldState, newState);

if (operations.length === 0) {
  console.log('No changes detected');
} else {
  console.log(`${operations.length} changes detected`);
}
```

## Behavior

### Identity

When comparing identical objects (by reference or deep equality), returns an empty array:

```typescript
const obj = { a: 1, b: 2 };

diff(obj, obj)  // []

diff({ a: 1 }, { a: 1 })  // []
```

### Type Changes

When a value changes type, generates a `replace` operation:

```typescript
diff({ value: 42 }, { value: "string" })
// [{ op: 'replace', path: '/value', value: 'string' }]

diff({ value: [1, 2] }, { value: { a: 1 } })
// [{ op: 'replace', path: '/value', value: { a: 1 } }]
```

### Nested Objects

Recursively compares nested structures:

```typescript
diff(
  { user: { name: "Alice", age: 30 } },
  { user: { name: "Bob", age: 30 } }
)
// [{ op: 'replace', path: '/user/name', value: 'Bob' }]
```

### Arrays

Compares array elements by index:

```typescript
diff({ items: [1, 2, 3] }, { items: [1, 5, 3] })
// [{ op: 'replace', path: '/items/1', value: 5 }]
```

::: warning
Current array comparison is naive (element-by-element). Large insertions or deletions may generate many operations.
:::

### Null vs Undefined

- `null` is a value (generates `replace`)
- `undefined` means missing (generates `remove`)

```typescript
diff({ value: 1 }, { value: null })
// [{ op: 'replace', path: '/value', value: null }]

diff({ value: 1 }, {})
// [{ op: 'remove', path: '/value' }]
```

## Performance

### Time Complexity

- **Best case**: O(1) - identical objects (strict equality check)
- **Average case**: O(n) - where n is the total number of properties/elements
- **Worst case**: O(n) - all properties/elements are different

### Space Complexity

- O(m) - where m is the number of differences (operations generated)
- Recursion depth is limited by object nesting depth

### Optimizations

1. **Strict equality check** - Early exit for unchanged values
2. **Set-based lookups** - O(1) key existence checks
3. **Reference comparison** - Fast check for unchanged nested objects

## Error Handling

### Invalid Input

The function accepts any input but works best with JSON-compatible values:

```typescript
// Valid inputs
diff({ a: 1 }, { a: 2 })  // Objects
diff([1, 2], [1, 3])      // Arrays
diff(null, { a: 1 })      // Null
diff(1, 2)                // Primitives

// Problematic inputs (not JSON-compatible)
diff({ fn: () => {} }, {})           // Functions
diff({ sym: Symbol() }, {})          // Symbols
diff({ date: new Date() }, {})       // Dates (compared as objects)
diff({ map: new Map() }, {})         // Maps, Sets, etc.
```

### Circular References

Circular references will cause infinite recursion:

```typescript
const obj = { a: 1 };
obj.self = obj;  // Circular reference

// This will cause a stack overflow
diff(obj, { a: 2 });  // ‚ùå Don't do this
```

::: warning
Ensure your objects don't contain circular references before calling `diff`.
:::

## Type Guards

### isOperation()

Utility function to check if an object is a valid JSON Patch operation:

```typescript
function isOperation(op: any): op is Operation
```

**Example:**
```typescript
import { isOperation } from 'zen-json-patch';

const maybeOp = { op: 'add', path: '/name', value: 'Alice' };

if (isOperation(maybeOp)) {
  // TypeScript knows maybeOp is Operation
  console.log(maybeOp.path);
}
```

## Constants

zen-json-patch doesn't export any constants. All operation types are string literals defined in the type system.

## Exports

The package exports the following:

```typescript
// Main function
export { diff };

// Types
export type {
  Operation,
  AddOperation,
  RemoveOperation,
  ReplaceOperation,
  MoveOperation,
  CopyOperation,
  TestOperation
};

// Utility functions
export { isOperation };

// Internal utilities (advanced usage only)
export { compareValues, appendPath, compareArrays };
```

::: warning Advanced Usage
Internal utilities like `compareValues`, `appendPath`, and `compareArrays` are exported for advanced use cases but are subject to change without major version bumps.
:::

## Next Steps

- [Usage Guide](/guide/usage) - Learn common patterns
- [Examples](/examples/) - See real-world examples
- [RFC 6902](/guide/rfc6902) - Understand the specification
